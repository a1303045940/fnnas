// SPDX-License-Identifier: (GPL-2.0+ OR MIT)
/dts-v1/;

#include <dt-bindings/gpio/gpio.h>
#include <dt-bindings/pwm/pwm.h>
#include <dt-bindings/leds/common.h>
#include <dt-bindings/input/input.h>
#include <dt-bindings/soc/rockchip,vop2.h>
#include <dt-bindings/pinctrl/rockchip.h>
#include <dt-bindings/thermal/thermal.h>
#include "rk3568.dtsi"

/ {
	model = "BenDian One RK3568 Ultimate Pro Router";
	compatible = "bendian,bd-one", "rockchip,rk3568";

	aliases {
		ethernet0 = &gmac0;
		ethernet1 = &gmac1;
		mmc0 = &sdhci;
		serial2 = &uart2;
	};

	chosen {
		stdout-path = "serial2:1500000n8";
	};

	/* 【细节 1】补全 CPU OPP 调频表：确保主频能稳定切换至 1.99GHz */
	cpu0_opp_table: opp-table-0 {
		compatible = "operating-points-v2";
		opp-shared;
		opp-408000000  { opp-hz = /bits/ 64 <408000000>;  opp-microvolt = <825000>; };
		opp-600000000  { opp-hz = /bits/ 64 <600000000>;  opp-microvolt = <825000>; };
		opp-816000000  { opp-hz = /bits/ 64 <816000000>;  opp-microvolt = <825000>; };
		opp-1104000000 { opp-hz = /bits/ 64 <1104000000>; opp-microvolt = <825000>; };
		opp-1416000000 { opp-hz = /bits/ 64 <1416000000>; opp-microvolt = <900000>; };
		opp-1608000000 { opp-hz = /bits/ 64 <1608000000>; opp-microvolt = <1000000>; };
		opp-1800000000 { opp-hz = /bits/ 64 <1800000000>; opp-microvolt = <1100000>; };
		opp-1992000000 { opp-hz = /bits/ 64 <1992000000>; opp-microvolt = <1150000>; };
	};

	/* 【细节 2】补全 GPU OPP 调频表：满血 800MHz 性能释放 */
	gpu_opp_table: opp-table-1 {
		compatible = "operating-points-v2";
		opp-200000000 { opp-hz = /bits/ 64 <200000000>; opp-microvolt = <825000>; };
		opp-400000000 { opp-hz = /bits/ 64 <400000000>; opp-microvolt = <825000>; };
		opp-600000000 { opp-hz = /bits/ 64 <600000000>; opp-microvolt = <900000>; };
		opp-800000000 { opp-hz = /bits/ 64 <800000000>; opp-microvolt = <1000000>; };
	};

	/* FIQ 调试器：深度死机日志抓取 */
	fiq-debugger {
		compatible = "rockchip,fiq-debugger";
		rockchip,serial-id = <2>;
		rockchip,wake-irq = <0>;
		rockchip,irq-mode-enable = <1>;
		rockchip,baudrate = <1500000>;
		interrupts = <GIC_SPI 252 IRQ_TYPE_LEVEL_LOW>;
		pinctrl-names = "default";
		pinctrl-0 = <&uart2m0_xfer>;
		status = "okay";
	};

	/* 风扇控制 (GPIO4_A7) - 55 度温控触发 */
	fan: gpio-fan {
		compatible = "gpio-fan";
		gpios = <&gpio4 RK_PA7 GPIO_ACTIVE_HIGH>;
		gpio-fan,speed-map = <0 0>, <3000 1>;
		pinctrl-names = "default";
		pinctrl-0 = <&fan_pins>;
		#cooling-cells = <2>;
	};

	/* LED 适配：红色电源 (4_B3), 绿色状态 (4_B1) */
	leds {
		compatible = "gpio-leds";
		pinctrl-names = "default";
		pinctrl-0 = <&led_pins>;
		led_power: led-0 {
			label = "red:power";
			gpios = <&gpio4 RK_PB3 GPIO_ACTIVE_LOW>;
			default-state = "on";
		};
		led_status: led-1 {
			label = "green:status";
			gpios = <&gpio4 RK_PB1 GPIO_ACTIVE_LOW>;
			linux,default-trigger = "heartbeat";
		};
	};

	/* NVME (PCIe 3.0) 外部时钟芯片供电 (GPIO0_C0) */
	vcc3v3_pcie: vcc3v3-pcie {
		compatible = "regulator-fixed";
		regulator-name = "vcc3v3_pcie";
		enable-active-high;
		gpio = <&gpio0 RK_PC0 GPIO_ACTIVE_HIGH>;
		pinctrl-names = "default";
		pinctrl-0 = <&pcie30_pwr_pin>;
		regulator-boot-on;
		regulator-always-on;
		vin-supply = <&vcc3v3_sys>;
	};

	dc_12v: dc-12v {
		compatible = "regulator-fixed";
		regulator-always-on;
		regulator-min-microvolt = <12000000>;
		regulator-max-microvolt = <12000000>;
	};

	vcc3v3_sys: vcc3v3-sys {
		compatible = "regulator-fixed";
		regulator-always-on;
		vin-supply = <&dc_12v>;
		regulator-min-microvolt = <3300000>;
		regulator-max-microvolt = <3300000>;
	};
};

/* --- 【干货】IO 域电平声明：确保网口、eMMC 通讯不乱码 --- */
&pmu_io_domains {
	status = "okay";
	pmuio1-supply = <&vcc3v3_pmu>;
	pmuio2-supply = <&vcc3v3_pmu>;
	vccio1-supply = <&vcc_3v3>;
	vccio2-supply = <&vcc_1v8>; /* eMMC/网口 1.8V IO */
	vccio3-supply = <&vcc_3v3>;
	vccio4-supply = <&vcc_3v3>;
	vccio5-supply = <&vcc_3v3>;
	vccio6-supply = <&vcc_3v3>;
	vccio7-supply = <&vcc_3v3>;
};

/* --- 核心组件开启 --- */
&gpu {
	status = "okay";
	mali-supply = <&vdd_gpu>;
	operating-points-v2 = <&gpu_opp_table>;
};

&vpu { status = "okay"; };
&rga { status = "okay"; };

&hdmi {
	status = "okay";
	pinctrl-names = "default";
	pinctrl-0 = <&hdmitx_scl &hdmitx_sda &hdmitxm0_cec>;
};
&hdmi_in { status = "okay"; };
&vop { status = "okay"; };

/* --- SATA 控制器满血开启 --- */
&combphy0 { status = "okay"; };
&combphy2 { status = "okay"; };
&sata0 { status = "okay"; };
&sata2 { status = "okay"; };

/* --- 5口交换机 + 原机时序优化 --- */
&mdio0 {
	#address-cells = <1>;
	#size-cells = <0>;
	rtl8367s: switch@1d {
		compatible = "realtek,rtl8365mb"; 
		reg = <0x1d>;
		reset-gpios = <&gpio1 RK_PA3 GPIO_ACTIVE_LOW>;
		ports {
			#address-cells = <1>;
			#size-cells = <0>;
			port@0 { reg = <0>; label = "lan4"; };
			port@1 { reg = <1>; label = "lan3"; };
			port@2 { reg = <2>; label = "lan2"; };
			port@3 { reg = <3>; label = "lan1"; };
			port@7 {
				reg = <7>;
				label = "cpu";
				ethernet = <&gmac0>;
				phy-mode = "rgmii";
				fixed-link { speed = <1000>; full-duplex; };
			};
		};
	};
};

&gmac0 {
	status = "okay";
	phy-mode = "rgmii";
	tx_delay = <0x4f>;
	rx_delay = <0x0f>;
	pinctrl-names = "default";
	pinctrl-0 = <&gmac0_miim &gmac0_tx_bus2 &gmac0_rx_bus2 &gmac0_rgmii_clk &gmac0_rgmii_bus>;
};

&gmac1 {
	status = "okay";
	phy-mode = "rgmii";
	snps,reset-gpio = <&gpio0 RK_PC5 GPIO_ACTIVE_LOW>;
	tx_delay = <0x4f>;
	rx_delay = <0x26>;
	pinctrl-0 = <&gmac1m1_miim &gmac1m1_tx_bus2 &gmac1m1_rx_bus2 &gmac1m1_rgmii_clk &gmac1m1_rgmii_bus>;
	phy-handle = <&rgmii_phy1>;
};

&mdio1 {
	rgmii_phy1: phy@0 {
		compatible = "ethernet-phy-ieee802.3-c22";
		reg = <0x0>;
	};
};

/* --- PCIe 3.0 NVME 稳定性细节 --- */
&pcie3x2 {
	reset-gpios = <&gpio0 RK_PC6 GPIO_ACTIVE_HIGH>;
	vpcie3v3-supply = <&vcc3v3_pcie>;
	aspm-no-l0s; /* 关键：禁用 L0s 以防 NVME 随机掉盘 */
	status = "okay";
};

&pcie30phy {
	data-lanes = <1 2>;
	status = "okay";
};

/* --- USB 2.0 --- */
&usb_host0_ehci { status = "okay"; };
&usb_host0_ohci { status = "okay"; };
&usb2phy0 { status = "okay"; };

/* --- 存储 eMMC 优化 --- */
&sdhci {
	bus-width = <8>;
	max-frequency = <200000000>;
	supports-emmc;
	non-removable;
	mmc-hs200-1_8v;
	vmmc-supply = <&vcc3v3_sys>;
	status = "okay";
};

/* --- PMIC (RK809) 睡眠同步与 PWM 步进调优 --- */
&i2c0 {
	status = "okay";
	rk809: pmic@20 {
		compatible = "rockchip,rk809";
		reg = <0x20>;
		interrupt-parent = <&gpio0>;
		interrupts = <RK_PA3 IRQ_TYPE_LEVEL_LOW>;
		pinctrl-names = "default", "pmic-sleep", "pmic-reset";
		pinctrl-0 = <&pmic_int>;
		pinctrl-1 = <&soc_slppin_slp>;
		pinctrl-2 = <&soc_slppin_rst>;
		
		regulators {
			vdd_logic: DCDC_REG1 {
				regulator-ramp-delay = <6001>; /* 提高电压切换稳定性 */
				regulator-initial-mode = <2>;
				regulator-state-mem { regulator-off-in-suspend; };
			};
			vdd_gpu: DCDC_REG2 {
				regulator-ramp-delay = <6001>;
				regulator-state-mem { regulator-off-in-suspend; };
			};
		};
	};
};

/* --- 引脚细节 Pinctrl --- */
&pinctrl {
	leds {
		led_pins: led-pins {
			rockchip,pins = <4 RK_PB3 RK_FUNC_GPIO &pcfg_pull_none>,
			                <4 RK_PB1 RK_FUNC_GPIO &pcfg_pull_none>;
		};
	};
	fan {
		fan_pins: fan-pins {
			rockchip,pins = <4 RK_PA7 RK_FUNC_GPIO &pcfg_pull_none>;
		};
	};
	pcie {
		pcie30_pwr_pin: pcie30-pwr-pin {
			rockchip,pins = <0 RK_PC0 RK_FUNC_GPIO &pcfg_pull_none>;
		};
	};
	pmic {
		soc_slppin_slp: soc-slppin-slp {
			rockchip,pins = <0 RK_PA2 1 &pcfg_pull_none>;
		};
		soc_slppin_rst: soc-slppin-rst {
			rockchip,pins = <0 RK_PA2 2 &pcfg_pull_none>;
		};
	};
};

&saradc {
	status = "okay";
	vref-supply = <&vcca_1v8_pmu>; 
};

&cpu_thermal {
	trips {
		cpu_active: cpu-active {
			temperature = <55000>;
			hysteresis = <2000>;
			type = "active";
		};
	};
	cooling-maps {
		map1 {
			trip = <&cpu_active>;
			cooling-device = <&fan THERMAL_NO_LIMIT THERMAL_NO_LIMIT>;
		};
	};
};

&uart2 { status = "okay"; };
